<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lvshuqi.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":330,"display":"hide","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null,"line_number":false},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":0},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="该博客在作者读大学本科期间创建，通过Hexo搭建，部署于Github Action。博客建立之初是为了防止作者遗忘已经学过的东西，将一些可以被记录的东西写下来一定程度上会减少遗忘。">
<meta property="og:type" content="website">
<meta property="og:title" content="就这样&amp;巴">
<meta property="og:url" content="https://lvshuqi.top/page/14/index.html">
<meta property="og:site_name" content="就这样&amp;巴">
<meta property="og:description" content="该博客在作者读大学本科期间创建，通过Hexo搭建，部署于Github Action。博客建立之初是为了防止作者遗忘已经学过的东西，将一些可以被记录的东西写下来一定程度上会减少遗忘。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shangjhih Jhao">
<meta property="article:tag" content="Hexo">
<meta property="article:tag" content="博客">
<meta property="article:tag" content="技术">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="随想">
<meta property="article:tag" content="编程">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://lvshuqi.top/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>就这样&巴</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">就这样&巴</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">个人网志</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lvshuqi.top/2025/10/19/TUNsystemgvisormixed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://s2.loli.net/2025/05/17/kIwcMmTsEvbpKfe.png">
      <meta itemprop="name" content="Shangjhih Jhao">
      <meta itemprop="description" content="该博客在作者读大学本科期间创建，通过Hexo搭建，部署于Github Action。博客建立之初是为了防止作者遗忘已经学过的东西，将一些可以被记录的东西写下来一定程度上会减少遗忘。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="就这样&巴">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/19/TUNsystemgvisormixed/" class="post-title-link" itemprop="url">TUN中三种路由区别</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-10-19 13:59:23 / 修改时间：14:42:56" itemprop="dateCreated datePublished" datetime="2025-10-19T13:59:23+08:00">2025-10-19</time>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TUN-虚拟网络栈"><a href="#TUN-虚拟网络栈" class="headerlink" title="TUN (虚拟网络栈)"></a>TUN (虚拟网络栈)</h1><p><strong>定义：</strong><code>TUN</code> 是一种虚拟网路介面，工作在 <code>OSI </code>模型的第三层（<code>IP 层</code>）。它不是一个实体硬体，而是一个软体驱动程式，允许使用者空间的程式像处理普通网路介面一样读取和写入 IP 封包。<br><strong>用途：</strong>当一个应用程式（例如 VPN 客户端）需要拦截或处理所有网路流量时，它会建立一个 <code>TUN</code> 栈。作业系统会将所有指定路由的流量发送到这个介面，然后应用程式从介面读取这些封包进行处理（例如加密）。处理完成后，应用程式再将封包写回介面，由作业系统发送到网路。</p>
<h2 id="TUN-的L3→L4-转换"><a href="#TUN-的L3→L4-转换" class="headerlink" title="TUN 的L3→L4 转换"></a>TUN 的L3→L4 转换</h2><p>用户空间的代理收到来自 TUN 的原始 IP 包（例如一个目标 IP&#x2F;端口的 <code>TCP SYN</code>），需要把这个 IP 包“翻译&#x2F;组装”成一个用户空间的 <code>TCP/UDP socket</code>（或把它交给系统内核栈）去建立连接并转发。这个过程叫 L3→L4 assemble（把 <code>IP</code> 包组装为<code> TCP/UDP</code> 连接）。不同实现选择把这项工作用<strong>系统内核栈</strong>来做，或用<strong>用户态的网络栈</strong>（如<code> gVisor</code> 风格实现）来做。<code>sing-box/sing-tun </code>就实现了这几种策略。</p>
<h1 id="system-gvisor-mixed三种stack的区别与应用"><a href="#system-gvisor-mixed三种stack的区别与应用" class="headerlink" title="system gvisor mixed三种stack的区别与应用"></a>system gvisor mixed三种stack的区别与应用</h1><h2 id="system"><a href="#system" class="headerlink" title="system"></a>system</h2><p>把接收到的 L3 包交由操作系统内核网络栈去处理（即在内核&#x2F;系统层面建立&#x2F;转发 <code>TCP/UDP </code>连接）。代理做的工作是路由与转发决策，但不重新实现<code> TCP/UDP</code>。</p>
<p><strong>优点：</strong>与系统兼容性最好、对 OS 现有防火墙 &#x2F; 路由规则亲和（通常延迟和 CPU 负载较低）。</p>
<p><strong>缺点：</strong>需要对系统防火墙与路由做更多配置（比如在 Linux 上可能需要 <code>nftables/iproute2 </code>的配合），在一些平台（或 sandbox 环境）无法轻易修改内核路由规则时不方便。<br><strong>实现方式</strong>： - 完全依赖操作系统的<code>TCP/IP</code>协议栈</p>
<ul>
<li><p>代理程序直接从TUN设备读取完整的IP数据包 </p>
</li>
<li><p>由系统内核完成TCP连接管理、拥塞控制、重传等<br><strong>特点</strong>：</p>
</li>
<li><p>✅ 性能最高（内核态处理，零拷贝优化） </p>
</li>
<li><p>✅ 兼容性最好（完全符合RFC标准）</p>
</li>
<li><p>❌ 需要内核级别权限 </p>
</li>
<li><p>❌ 在某些平台（如Android）可能受限</p>
</li>
</ul>
<p><strong>System模式问题</strong>：</p>
<ul>
<li>系统内核的TCP栈可能有一些”优化”行为（如窗口缩放、时间戳选项、快速打开）</li>
<li>经过Hysteria2的UDP封装后，这些特性的时序可能被打乱</li>
<li>某些网站的防火墙&#x2F;负载均衡器可能误判为异常流量</li>
</ul>
<h2 id="gVisor"><a href="#gVisor" class="headerlink" title="gVisor"></a>gVisor</h2><p>在用户空间实现一个虚拟的网络协议栈（受 gVisor 启发），代理在用户态模拟&#x2F;处理 TCP 与 UDP；换言之代理重建并管理传输层。</p>
<p><strong>优点：</strong>更强的隔离性（不需要改内核路由或防火墙），在受限环境或需要“捕获全部流量而不改系统设置”的场景下更可靠；某些情况下还能避免内核&#x2F;用户态切换带来的成本。</p>
<p><strong>缺点：</strong>实现复杂、CPU 占用可能更高（尤其是高并发下用户态处理多连接），对某些低层网络行为（如某些 NAT 行为、路径 MTU、特定 ICMP&#x2F;非标准包）表现不同。文档也说明 gvisor 栈可提供 endpoint-independent NAT 等可选行为。<br><strong>实现方式</strong>： </p>
<ul>
<li>使用Google开源的gVisor项目中的<strong>netstack</strong>组件</li>
<li>在<strong>用户空间</strong>完整实现<code>TCP/IP</code>协议栈（Go语言编写）</li>
<li>不依赖系统内核的网络功能 </li>
<li><strong>技术细节</strong>： </li>
<li>自己处理TCP状态机、滑动窗口、快速重传、拥塞控制（如<code>Cubic/BBR</code>）</li>
<li>完整的NAT转换和连接跟踪 </li>
<li>独立的路由表和防火墙规则<br> <strong>特点</strong>：</li>
<li>✅ 无需特殊权限（相对<code>system</code>模式）</li>
<li>✅ 跨平台一致性好 </li>
<li>✅ 更强的隔离性和安全性</li>
<li>❌ 性能略低于<code>system</code>（用户态 vs 内核态）</li>
<li>✅ <strong>协议实现更严格</strong>（这是你问题的关键）</li>
</ul>
<h2 id="mixed"><a href="#mixed" class="headerlink" title="mixed"></a>mixed</h2><p>混合策略：<code>TCP</code> 用 <code>system</code>（系统栈）处理，UDP 用 <code>gvisor</code>（用户态）处理。设计上的折衷是利用系统对 TCP 的成熟处理，同时用<code> gvisor</code> 捕获 UDP（例如<code> QUIC/HTTP/3/</code>或其他 <code>UDP-based </code>协议）。<br>设计意图：兼顾兼容性与对<code>UDP</code>的更好捕获&#x2F;隔离。<br><strong>实现方式</strong>：</p>
<ul>
<li>通常默认使用system模式</li>
<li>遇到特定情况时切换到<code>gVisor</code>（如需要更精细控制）</li>
<li>或者按连接类型分流（<code>TCP</code>用<code>system</code>，<code>UDP</code>用<code>gVisor</code>）</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 试图平衡性能和兼容性</li>
<li>❌ 切换逻辑可能引入bug</li>
<li>❌ 状态管理更复杂</li>
</ul>
<h1 id="节点协议"><a href="#节点协议" class="headerlink" title="节点协议"></a>节点协议</h1><p>在推荐的使用协议中，vless和hysteria2都是极为推荐的协议，其中vless主要使用tcp协议的流量进行通信，儿Hysteria2使用的则是TUIC&#x2F;UDP流量。</p>
<h2 id="协议栈推荐"><a href="#协议栈推荐" class="headerlink" title="协议栈推荐"></a>协议栈推荐</h2><p>在使用任何协议的节点时都要注意使用合适的TUN模式来对流量进行路由，由于安卓设备和Windows设备的路由中都有可能出现某些流量不遵循系统路由规范的情况，所以在未进行针对设置的情况下有些服务是无法正常使用的，也就是软件会绕过代理进行直连。这个时候你可能会遇到部分网站无法访问的情况（比如Claude），假如你使用xray和sing-box系列的代理工具，很多默认使用mixed路由规范的工具就会无法正确路由该网站的流量，导致访问失败。</p>
<p>假如流量出现异常，请尝试使用gVisor模式作为路由规范，此时将会新建一个虚拟网卡，所有的流量都会交由虚拟网卡处理，阻止一些不遵守规范的服务绕过路由规则。此时所有的流量都会跟随预先设计的路由规则分发流量与连接。</p>
<p style="color:red; font-weight:bold">
如连接出现问题，请将您的TUN模式修改为gVisor。
</p>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/82/">82</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shangjhih Jhao"
      src="https://s2.loli.net/2025/05/17/kIwcMmTsEvbpKfe.png">
  <p class="site-author-name" itemprop="name">Shangjhih Jhao</p>
  <div class="site-description" itemprop="description">该博客在作者读大学本科期间创建，通过Hexo搭建，部署于Github Action。博客建立之初是为了防止作者遗忘已经学过的东西，将一些可以被记录的东西写下来一定程度上会减少遗忘。</div>
</div>


<div class="spotify-player-independent motion-element">
  <div class="spotify-player-header">
    <i class="fab fa-spotify"></i>
    <span>音乐推荐</span>
  </div>
  <div class="spotify-player-content">
    <iframe style="border-radius:8px" 
            src="https://open.spotify.com/embed/track/1TUpKepASZ9fQbcG2v9kOy?utm_source=generator" 
            width="100%" 
            height="152" 
            frameBorder="0" 
            allowfullscreen="" 
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
            loading="lazy">
    </iframe>
  </div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">90</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shangjhih Jhao</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">344k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:33</span>
</div>
<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("09/29/2024 11:04:00"); //此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已建立 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒.";
    }
setInterval("createtime()",250);
</script>
        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
